#!/usr/bin/python
#
# use avahi to find a _apt_proxy._tcp provider and return
# a http proxy string suitable for apt

import os
import sys
import socket
from subprocess		import Popen, PIPE


# Obtain all of the services addresses from avahi, pulling the IPv6 addresses
# to the top.
def is_ipv6(a):
    return a.find(':') >= 0

service = '_apt_proxy._tcp'
p = Popen(['avahi-browse', '-kprt', service], stdout=PIPE)
addr4 = []
addr6 = []
for line in p.stdout:
    if line[0] == '=':
        bits = line.split(';')
        if is_ipv6(bits[7]):
            addr6.append([bits[7], bits[8]])
        else:
            addr4.append([bits[7], bits[8]])

addrs = addr6 + addr4

# Run through the offered addresses and see if we we have a bound local
# address for it.
address = None
for addr in addrs:
    (ip, port) = addr

    try:
        res = socket.getaddrinfo(ip, port, 0, 0, 0, socket.AI_ADDRCONFIG)
        address = addr
        break
    except socket.gaierror:
        pass

# Dump the approved address out in an appropriate format.
if address:
    (ip, port) = address
    if is_ipv6(ip):
        print "http://[%s]:%s/" % (ip, port)
    else:
        print "http://%s:%s/" % (ip, port)
